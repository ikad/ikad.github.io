<!DOCTYPE html>
<html>
<head>
  <title></title>
</head>
<body>
  <h1>Hello</h1>

  <form id="post-form">
    <input name="authenticity_token" id="csrf-token" type="hidden">
    <input name="post[title]">
    <input type="submit">
  </form>

  <div id="posts"></div>

  <script>
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "//ikad-api-sample.herokuapp.com/api/posts", true);
    xhr.onload = function() {
      var posts_elm = document.getElementById("posts");
      var json = JSON.parse(xhr.responseText);
      for (var i=0;i<json.length;i++) {
        var p_elm = document.createElement("p");
        p_elm.innerHTML = json[i].title;
        posts_elm.appendChild(p_elm);
      }
    }
    xhr.send(null);

    var form_elm = document.getElementById("post-form");
    form_elm.onsubmit = function(e) {
      e.preventDefault();

      var xhr = new XMLHttpRequest();
      xhr.open("GET", "//ikad-api-sample.herokuapp.com/api/posts/new", true);
      xhr.withCredentials = true;
      xhr.onload = function() {
        var csrf_elm = document.getElementById("csrf-token");
        csrf_elm.value = JSON.parse(xhr.responseText).token;
        sendPost();
      }
      xhr.send(null);
    }

    function sendPost() {
      var xhr2 = new XMLHttpRequest();
      xhr.open("POST", "//ikad-api-sample.herokuapp.com/api/posts", true);
      xhr.withCredentials = true;
      xhr.send(new FormData(form_elm));
    }
  </script>
</body>
</html>